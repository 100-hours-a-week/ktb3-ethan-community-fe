<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>아무 말 대잔치 - 홈</title>
    <link rel="stylesheet" href="./style/new.css">

    <script type="module" src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>
    <!-- <link rel="stylesheet" href="./style/common.css">
    <link rel="stylesheet" href="./style/index.css">
    
    <script src="./scripts/common.js"></script>
    <script type="module" src="./scripts/posts.js"></script> -->
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const grid = document.querySelector('#postGrid');
        const loader = document.querySelector('#loader');

        // Masonry 초기화
        const msnry = new Masonry(grid, {
            itemSelector: '.grid-item',
            columnWidth: '.grid-sizer',
            percentPosition: true,
            gutter: 16,
            transitionDuration: '0.25s',
        });

        let isLoading = false;
        let postCount = 0;

        // 더미 카드 생성 함수
        function createPostItem(index) {
            const heights = [160, 190, 220, 260, 300];
            const randomHeight =
                heights[Math.floor(Math.random() * heights.length)];

            const gridItem = document.createElement('div');
            gridItem.className = 'grid-item';

            const card = document.createElement('article');
            card.className = 'post-card';

            const media = document.createElement('div');
            media.style.height = randomHeight + 'px';
            media.style.background =
                'linear-gradient(135deg, #ffdee9, #b5fffc)';

            const body = document.createElement('div');
            body.style.padding = '12px 14px 10px';

            const title = document.createElement('div');
            title.style.fontSize = '0.95rem';
            title.style.fontWeight = '600';
            title.style.marginBottom = '4px';
            title.textContent = `Masonry.js 예시 게시글 #${index}`;

            const meta = document.createElement('div');
            meta.style.marginTop = '8px';
            meta.style.fontSize = '0.75rem';
            meta.style.color = '#6b7280';
            meta.textContent = `조회수 ${(index * 17) % 999} · 댓글 ${
                (index * 3) % 50
            }`;

            body.appendChild(title);
            body.appendChild(meta);
            card.appendChild(media);
            card.appendChild(body);
            gridItem.appendChild(card);

            return gridItem;
        }

        // 초기 카드 로드
        function loadInitialPosts() {
            const initialItems = [];
            for (let i = 0; i < 16; i++) {
                postCount++;
                initialItems.push(createPostItem(postCount));
            }
            initialItems.forEach((item) => grid.appendChild(item));
            // 이미지가 있다면 이미지 로딩 이후에 layout() 호출 권장
            msnry.appended(initialItems);
            msnry.layout();
        }

        // 추가 카드 로드 (인피니티 스크롤)
        function loadMorePosts() {
        if (isLoading) return;
        isLoading = true;
        loader.textContent = '불러오는 중…';

        setTimeout(() => {
            const newItems = [];
            for (let i = 0; i < 12; i++) {
            postCount++;
            newItems.push(createPostItem(postCount));
            }
            newItems.forEach((item) => grid.appendChild(item));

            // Masonry에 새로 들어온 아이템 알려주기
            msnry.appended(newItems);
            msnry.layout();

            loader.textContent = '스크롤하면 더 많은 글을 불러옵니다…';
            isLoading = false;
        }, 500);
        }

        // 스크롤 감지
        function onScroll() {
        const scrollPosition = window.innerHeight + window.scrollY;
        const threshold = document.body.offsetHeight - 600;

        if (scrollPosition >= threshold) {
            loadMorePosts();
        }
        }

        // 초기 실행
        loadInitialPosts();
        window.addEventListener('scroll', onScroll);
    });
</script>

</head>
<body>
    <main class="feed-container">

    <!-- 여기 부분이 Masonry 타겟 -->
    <section class="grid" id="postGrid">
        <!-- grid-sizer: 한 칼럼의 너비 기준 -->
        <div class="grid-sizer"></div>
    </section>

    <div class="loader" id="loader">더보기</div>
    </main>
</body>
</html>
